#!/bin/sh

LOG_FILE=".git/hooks/pre-push.log"
: > "$LOG_FILE"

msg() {
  printf '[pre-push] %s\n' "$1" >&2
  printf '[pre-push] %s\n' "$1" >> "$LOG_FILE"
}

run_cmd() {
  msg "Running: $*"
  TMP_LOG="${LOG_FILE}.tmp"
  : > "$TMP_LOG"

  "$@" > "$TMP_LOG" 2>&1
  status=$?

  while IFS= read -r line; do
    printf '%s\n' "$line" >&2
  done < "$TMP_LOG"

  cat "$TMP_LOG" >> "$LOG_FILE"
  rm -f "$TMP_LOG"

  return $status
}

msg "Running release checks (release-intent + SemVer validation)..."

# Keep hook portable: avoid npm wrapper scripts that may depend on bash.
PYTHON_BIN=""
if command -v python >/dev/null 2>&1; then
  PYTHON_BIN="python"
elif command -v python3 >/dev/null 2>&1; then
  PYTHON_BIN="python3"
elif command -v py >/dev/null 2>&1; then
  PYTHON_BIN="py -3"
else
  msg "Blocked: no Python interpreter found in PATH."
  exit 1
fi

eval "run_cmd $PYTHON_BIN versioning/check_release_intent.py --pre-push"
status=$?

if [ $status -ne 0 ]; then
  msg "Blocked: release-intent check failed (see messages above)."
  exit $status
fi

eval "run_cmd $PYTHON_BIN versioning/validate_semver.py"
status=$?

if [ $status -ne 0 ]; then
  msg "Blocked: semver validation failed (see messages above)."
  exit $status
fi

msg "OK"
exit 0
